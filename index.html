<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Queens League Oysho - Álbum Virtual y Fantasy</title>
    <meta name="description" content="Álbum virtual de Queens League Oysho — sobres, cromos y bonos" />
    <link rel="icon" href="https://queensleague.pro/favicon.ico" />
    <style>
        :root{
            --bg: #2a0a49; /* Fondo lila */
            --accent: #06ccbd;
            --accent-text: #2a0a49;
            --card-bg: #e5e7eb;
            --white: #ffffff;
            --danger: #e11d48;
            --shadow-accent: rgba(6,204,189,0.18);
            --max-width: 1100px;
            --radius: 12px;
            --transition: 200ms ease;
            --header-height: 72px;
            --pack-cost: 750;
            --cromo-dark-bg: #4b2b6c; /* Fondo oscuro para cromos */
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--white);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.4;
        }

        /* HEADER */
        header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 1rem;
            padding: 0 1.25rem;
            background: var(--bg);
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 3px 12px var(--shadow-accent);
            position: sticky;
            top: 0;
            z-index: 50;
            height: var(--header-height);
        }
        .header-left { justify-self: start; display: flex; align-items: center; gap: 0.8rem; }
        .header-center { justify-self: center; display: flex; align-items: center; }
        .header-right { justify-self: end; display: flex; align-items: center; gap: 0.75rem; }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 0.4px;
            cursor: pointer;
        }

        .redes { display: flex; gap: 0.6rem; align-items: center; }
        .redes a { color: var(--accent); text-decoration: none; padding: 0.2rem 0.45rem; border-radius: 8px; font-weight: 600; font-size: 0.92rem; }
        .redes a:hover { background: var(--accent); color: var(--accent-text); }
        .redes img { height: 28px; width: auto; }

        #monedas-panel { background: var(--accent); color: var(--accent-text); padding: .32rem .75rem; border-radius: 10px; font-weight: 700; box-shadow: 0 6px 20px var(--shadow-accent); white-space: nowrap; }

        /* MAIN */
        #main-content {
            max-width: var(--max-width);
            margin: 1rem auto;
            padding: 1rem;
            background: transparent;
            color: var(--white);
            border-radius: var(--radius);
            box-shadow: none;
            min-height: 0;
            overflow: visible;
        }

        /* FANTASY AUTH PANEL */
        #auth-panel {
            max-width: 400px;
            margin: 2rem auto;
            padding: 20px;
            background: var(--cromo-dark-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-accent);
        }
        #auth-panel h2 { color: var(--accent); margin-top: 0; }
        #auth-panel input { color: var(--accent-text); background-color: var(--white); width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; border-radius: 8px; border: none;}
        #auth-panel .login-btn { background-color: var(--accent); color: var(--accent-text); border: none; padding: .6rem .9rem; border-radius: 8px; cursor: pointer; font-weight:700; width: 100%; margin-top: 10px;}
        #auth-panel a { color: var(--accent); font-weight: bold; text-decoration: none; }
        .mensaje { margin-top: 15px; text-align: center; padding: 10px; border-radius: 8px; font-weight: bold; }
        .error { background-color: #e11d4833; color: var(--danger); }
        .exito { background-color: #06ccbd33; color: var(--accent); }
        .album-grid, .packs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .cromo { background: var(--cromo-dark-bg); border-radius: 10px; padding: .5rem; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; position:relative; box-shadow: 0 6px 16px rgba(6,204,189,0.06); min-height: 140px; }
        .cromo img { width:100px; height:140px; object-fit:cover; border-radius:8px; border: 3px solid var(--accent); background: var(--white); cursor:pointer; transition: transform var(--transition); }
        .pack { position:relative; height:160px; border-radius:12px; overflow:hidden; cursor:pointer; border:3px solid rgba(6,204,189,0.08); box-shadow: 0 10px 28px rgba(6,204,189,0.06); display:flex; align-items:center; justify-content:center; }
        .pack img { width:100%; height:100%; object-fit:cover; display:block; }
        .pack .pack-badge { position:absolute; right:8px; bottom:8px; background:var(--accent); color:var(--accent-text); padding:6px 8px; border-radius:8px; font-weight:800; }
        .pack.opened { opacity:.55; filter:grayscale(30%); cursor:default; transform:scale(.98); }
        .duplicadas { position:absolute; top:8px; right:10px; background: var(--accent); color: var(--accent-text); padding:6px 10px; border-radius:999px; font-weight:800; }
        .btn-vender { position:absolute; bottom:8px; right:8px; background: var(--accent); color: var(--accent-text); border: none; padding:6px 10px; border-radius:8px; font-weight:700; cursor:pointer; }
        .modal-box { width: min(92vw, 920px); background: var(--white); border-radius: 12px; padding: 18px; text-align: center; color: var(--accent-text); box-shadow: 0 18px 48px rgba(6,204,189,0.12); position: relative; }
        .modal-close { position: absolute; top: 10px; right: 12px; font-size: 1.6rem; color: var(--accent); background: transparent; border: none; cursor: pointer; }
        #modal, #modal-cards, #modal-creator-code { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(42,10,73,0.78); z-index: 1200; padding: 1rem; pointer-events: none; }
        #modal[style*="display: flex"], #modal-cards[style*="display: flex"], #modal-creator-code[style*="display: flex"] { display:flex !important; pointer-events:auto; }
        #notificacion { position: fixed; top: 28px; left: 50%; transform: translateX(-50%); background: var(--accent); color: var(--accent-text); padding: 10px 20px; border-radius: 12px; font-weight:800; z-index: 2000; display:none; }

        .menu-principal { display: flex; justify-content: center; margin-top: 1.5rem; }
        .menu-principal .actions { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; }
        .menu-principal button { padding: 10px 15px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer; transition: background 200ms; }
    </style>
</head>
<body style="background-color: #2a0a49 !important;">
    <header>
        <div class="header-left">
            <div class="logo" id="logo">
                <img src="https://i.ibb.co/gLStSbFz/000-LOGO.png" alt="Queens League Oysho Logo" style="height:42px;">
            </div>
        </div>

        <div class="header-center">
            <div id="user-info-panel" role="status" aria-live="polite">
                <span id="monedas-panel">Monedas: 0</span>
            </div>
        </div>

        <div class="header-right">
            <button id="btnAcceso" class="login-btn">Acceder</button>

            <nav class="redes" aria-label="Redes">
                <a href="https://instagram.com/QueensLeague" target="_blank" rel="noopener">
                    <img src="https://i.ibb.co/R4snZts1/INSTAGRAM.png" alt="Instagram Logo">
                </a>
                <a href="https://x.com/QueensLeague" target="_blank" rel="noopener">
                    <img src="https://i.ibb.co/nqMPfypC/X-Twitter.png" alt="X (Twitter) Logo">
                </a>
                <a href="https://www.tiktok.com/@queensleague" target="_blank" rel="noopener">
                    <img src="https://i.ibb.co/FtZQ0j9/TIK-TOK.png" alt="TikTok Logo">
                </a>
            </nav>
            <a href="https://queensleague.pro" target="_blank" rel="noopener">
                <img src="https://kingsleague-cdn.kama.football/account/production/competition/ql-short-logo.png" alt="Queens League Logo" style="height: 28px; width: auto;">
            </a>
        </div>
    </header>

    <main id="main-content" role="main" tabindex="-1">
        <p style="text-align: center; color: var(--accent);">Cargando contenido...</p>
    </main>

    <div id="auth-panel" style="display: none;">
        <div id="login-form">
            <h2 style="color: var(--accent); margin-top: 0;">Iniciar Sesión</h2>
            <input type="email" id="emailLogin" placeholder="Email" required>
            <input type="password" id="passwordLogin" placeholder="Contraseña" required>
            <button id="btnLogin" class="login-btn">Entrar</button>
            <p style="text-align: center; font-size: 0.9em; margin-top: 15px;">¿No tienes cuenta? <a href="#" onclick="mostrarRegistro(); return false;">Regístrate aquí</a></p>
        </div>

        <div id="registro-form" style="display: none;">
            <h2 style="color: var(--accent); margin-top: 0;">Registro</h2>
            <input type="email" id="emailRegistro" placeholder="Email" required>
            <input type="password" id="passwordRegistro" placeholder="Contraseña (mínimo 6 caracteres)" required>
            <button id="btnRegistro" class="login-btn">Registrarme</button>
            <p style="text-align: center; font-size: 0.9em; margin-top: 15px;">¿Ya tienes cuenta? <a href="#" onclick="mostrarLogin(); return false;">Inicia Sesión</a></p>
        </div>

        <div id="mensajes" class="mensaje" style="display: none;"></div>
    </div>
    <div id="modal" aria-hidden="true" role="dialog">
        <div class="modal-box" role="document">
          <button class="modal-close" id="modal-close" aria-label="Cerrar">&times;</button>
          <div class="modal-info-top" id="modal-info-top"></div>
          <div class="modal-img-wrap"><img id="modal-img" src="" alt="Cromo ampliado"></div>
        </div>
    </div>

    <div id="modal-cards" aria-hidden="true" role="dialog">
        <div class="modal-box" id="modal-cards-box">
          <button class="modal-close" id="modal-cards-close" aria-label="Cerrar">&times;</button>
          <div id="modal-cards-info" class="modal-info-top"></div>
          <div id="modal-cards-grid" class="album-grid"></div>
        </div>
    </div>

    <div id="modal-creator-code" aria-hidden="true" role="dialog">
        <div class="modal-box">
          <button class="modal-close" id="modal-creator-code-close" aria-label="Cerrar">&times;</button>
          <div class="modal-info-top">Introduce tu código de creador</div>
          <input type="text" id="creator-code-input" placeholder="Introduce un código de creador Queens" style="width: 80%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; text-align: center; color: var(--accent-text);">
          <button id="redeem-creator-code" class="login-btn">Canjear Código</button>
        </div>
    </div>
    <div id="notificacion" role="status" aria-live="polite"></div>

    <footer>
        <div class="footer-content" style="flex-direction: column; gap: 0.4rem; text-align: center;">
            <span>Hecho con &#x1F497; por IzanDHH</span>
            <span style="font-size: 0.85em; color: rgba(255,255,255,0.7);">
                DISCLAIMER &#x26A0;: Los derechos de imagen pertenecen a Kosmos Holding (Queens League) y cualquier reclamación de la retirada de imagen que se solicite se realizará asi.
            </span>
            <span style="font-size: 0.85em; color: rgba(255,255,255,0.7);">
                Esta web esta hecha para el fandom de la Queens League Oysho Spain & Americas
            </span>
            <span class="login-btn" style="margin-top: 10px; max-width: 250px; cursor: default;">Redes del proyecto</span>
            <a href="https://x.com/QL_Cards" target="_blank" rel="noopener" style="margin-top: 5px;">
                <img src="https://i.ibb.co/nqMPfypC/X-Twitter.png" alt="X (Twitter) Logo" style="height: 28px; width: auto;">
            <a href="https://instagram.com/QL_Cards" target="_blank" rel="noopener" style="margin-top: 5px;">
                <img src="https://i.ibb.co/R4snZts1/INSTAGRAM.png" alt="Instagram Logo" style="height: 28px; width: auto;">
            </a>
        </div>
    </footer>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ==========================================================
        // ⚠️ PASO CRÍTICO: REEMPLAZA CON TUS PROPIAS CLAVES DE SUPABASE
        // ==========================================================
        const SUPABASE_URL = '⚠️ TU_URL_SUPABASE'; 
        const SUPABASE_ANON_KEY = '⚠️ TU_KEY_SUPABASE_ANON'; 

        // Inicializar Supabase
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Referencias a los nuevos elementos HTML ---
        const authPanel = document.getElementById('auth-panel');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const registroForm = document.getElementById('registro-form');
        const mensajesDiv = document.getElementById('mensajes');
        const btnAcceso = document.getElementById('btnAcceso');
        const userInfoPanel = document.getElementById('user-info-panel');
        
        // Referencias de Input
        const emailLogin = document.getElementById('emailLogin');
        const passwordLogin = document.getElementById('passwordLogin');
        const emailRegistro = document.getElementById('emailRegistro');
        const passwordRegistro = document.getElementById('passwordRegistro');
        
        let currentUserId = null; // Variable global para almacenar el ID del usuario logueado

        // --- Funciones de Utilidad del Formulario ---

        function mostrarMensaje(texto, esError) {
            mensajesDiv.textContent = texto;
            mensajesDiv.className = 'mensaje ' + (esError ? 'error' : 'exito');
            mensajesDiv.style.display = 'block';
        }

        function mostrarLogin() {
            registroForm.style.display = 'none';
            loginForm.style.display = 'block';
            mensajesDiv.style.display = 'none';
        }

        function mostrarRegistro() {
            loginForm.style.display = 'none';
            registroForm.style.display = 'block';
            mensajesDiv.style.display = 'none';
        }
        
        function mostrarContenido(showAuth) {
            authPanel.style.display = showAuth ? 'block' : 'none';
            mainContent.style.display = showAuth ? 'none' : 'block';
            if (showAuth) mostrarLogin();
        }


        // --- LÓGICA DE AUTENTICACIÓN PRINCIPAL ---

        async function handleAuthChange(event, session) {
            if (session) {
                // USUARIO LOGUEADO
                const userEmail = session.user.email;
                currentUserId = session.user.id; 

                mostrarContenido(false); 

                btnAcceso.textContent = 'Salir';
                btnAcceso.onclick = cerrarSesion; 
                
                userInfoPanel.innerHTML = `<span id="monedas-panel">Monedas: ${monedas}</span> | ${userEmail}`;
                
                // Inicializa el álbum CON el ID del usuario.
                inicializarAlbum(currentUserId); 

            } else {
                // USUARIO DESLOGUEADO
                currentUserId = null;
                
                mostrarContenido(true); 
                
                btnAcceso.textContent = 'Acceder';
                btnAcceso.onclick = () => mostrarContenido(true); 
                
                // Reiniciar estado visual
                userInfoPanel.innerHTML = `<span id="monedas-panel">Monedas: 0</span>`;
                mainContent.innerHTML = '<p style="text-align: center; color: var(--accent);">Inicia sesión para ver tu álbum.</p>';
            }
        }

        async function iniciarSesion() {
            const email = emailLogin.value;
            const password = passwordLogin.value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                mostrarMensaje(`Error: ${error.message || 'Email o contraseña incorrectos.'}`, true);
            }
        }

        async function registrarUsuario() {
            const email = emailRegistro.value;
            const password = passwordRegistro.value;
            const { data, error } = await supabase.auth.signUp({ email, password });

            if (error) {
                mostrarMensaje(`Error al registrar: ${error.message}`, true);
            } else {
                mostrarMensaje('¡Registro exitoso! Revisa tu email para confirmar la cuenta.', false);
                mostrarLogin();
            }
        }
        
        async function cerrarSesion() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error al cerrar sesión:', error);
            }
        }

        // ==========================================================
        //         LÓGICA COMPLETA DEL ÁLBUM (TU CÓDIGO)
        // ==========================================================
        
        // --- CONSTANTES GLOBALES ---
        const PACK_COST = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--pack-cost')) || 750;
        const PACK_SLOTS = 3; 
        const TOTAL_PACKS_DISPLAY = 10;
        const SELL_PRICE_PER_DUPE = 50;
        const DAILY_REWARD = 1000;
        const REVERSO = "https://i.ibb.co/F443KZqx/00-REVERSO.png";

        const CARDS = [
            { id:1,nombre:"Escudo 1K",tipo:"escudo",imagen:"https://i.ibb.co/CpJ3c7B8/01-Escudo1-K.png"},
            { id:2,nombre:"Escudo Aniquiladoras FC",tipo:"escudo",imagen:"https://i.ibb.co/N2hVWpqv/02-Escudo-Aniquiladoras.png"},
            { id:3,nombre:"Escudo El Barrio",tipo:"escudo",imagen:"https://i.ibb.co/7JcZNXSQ/03-Escudo-Barrio.png"},
            { id:4,nombre:"Escudo Jijantas FC",tipo:"escudo",imagen:"https://i.ibb.co/d4w5ppfS/04-Escudo-Jijantas.png"},
            { id:5,nombre:"Escudo Kunitas",tipo:"escudo",imagen:"https://i.ibb.co/RMxrmnY/05-Escudo-Kunitas.png"},
            { id:6,nombre:"Escudo Las Troncas FC",tipo:"escudo",imagen:"https://i.ibb.co/TDwwW6Qj/06-Escudo-Las-Troncas.png"},
            { id:7,nombre:"Escudo PIO FC",tipo:"escudo",imagen:"https://i.ibb.co/Fk5XtqqS/07-Escudo-PIO.png"},
            { id:8,nombre:"Escudo Porcinas FC",tipo:"escudo",imagen:"https://i.ibb.co/W4D56C3R/08-Escudo-Porcinas.png"},
            { id:9,nombre:"Escudo Rayo de Barcelona",tipo:"escudo",imagen:"https://i.ibb.co/wr7Q4sVP/09-Escudo-Rayo-De-Barcelona.png"},
            { id:10,nombre:"Escudo Saiyans FC",tipo:"escudo",imagen:"https://i.ibb.co/9kxn2vn9/10-Escudo-Saiyans-FC.png"},
            { id:11,nombre:"Escudo Ultimate Móstoles",tipo:"escudo",imagen:"https://i.ibb.co/zVGgWPTf/11-Escudo-Ultimate-M-stoles.png"},
            { id:12,nombre:"Escudo Xbuyer Team",tipo:"escudo",imagen:"https://i.ibb.co/nM27z99j/12-Escudo-XBuyer-Team.png"},
            { id:37,nombre:"Escudo Atlético Parceras",tipo:"escudoqlame",imagen:"https://i.ibb.co/NdZKc3sJ/37-Escudo-Atletico-Parceras.png"},
            { id:38,nombre:"Escudo Club de Cuervos",tipo:"escudoqlame",imagen:"https://i.ibb.co/tpX3Dpbk/38-Escudo-Club-De-Cuervos.png"},
            { id:39,nombre:"Escudo Galácticas del Caribe",tipo:"escudoqlame",imagen:"https://i.ibb.co/bjs2K3sy/39-Escudo-Galacticas-Del-Caribe.png"},
            { id:40,nombre:"Escudo Las Aliens FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/YFmK6Fdn/40-Escudo-Las-Aliens-FC.png"},
            { id:41,nombre:"Escudo Las Chamas FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/HTwMP29d/41-Escudo-Las-Chamas-FC.png"},
            { id:42,nombre:"Escudo Las Santas FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/dspST13h/42-Escudo-Las-Santas-FC.png"},
            { id:43,nombre:"Escudo Muchachas FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/S70w9X3P/43-Muchachas-FC.png"},
            { id:44,nombre:"Escudo Olimpo United",tipo:"escudoqlame",imagen:"https://i.ibb.co/kVm2q728/44-Olimpo-United.png"},
            { id:45,nombre:"Escudo Peluche Caligari",tipo:"escudoqlame",imagen:"https://i.ibb.co/wFJcxQb0/45-Peluche-Caligari.png"},
            { id:46,nombre:"Escudo Persas FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/7BvQbZZ/46-Persas-FC.png"},
            { id:47,nombre:"Escudo Raniza FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/9J05rkc/47-Raniza-FC.png"},
            { id:48,nombre:"Escudo Real Titán FC",tipo:"escudoqlame",imagen:"https://i.ibb.co/ymsDVfCs/48-Real-Titan-FC.png"},
            { id:13,nombre:"Mayichi (1K)",tipo:"presidenta",imagen:"https://i.ibb.co/0p9Js9tm/13-Mayichi.png"},
            { id:14,nombre:"Ama Blitz (Aniquiladoras FC)",tipo:"presidenta",imagen:"https://i.ibb.co/MDN445S2/14-Amablitz.png"},
            { id:15,nombre:"Adri Contreras + Mercedes Roa (El Barrio)",tipo:"presidenta",imagen:"https://i.ibb.co/V01ZjqVb/15-Mercedes-Roa-Adri-Contreras.png"},
            { id:16,nombre:"Gerard Romero + Lis Cid (Jijantas FC)",tipo:"presidenta",imagen:"https://i.ibb.co/tTncqzTb/16-Gerard-Romero-Lis-Cid.png"},
            { id:17,nombre:"Jo Valicenti (Kunitas)",tipo:"presidenta",imagen:"https://i.ibb.co/whpJcVz0/17-Jo-Valicenti.png"},
            { id:18,nombre:"Violeta (Las Troncas FC)",tipo:"presidenta",imagen:"https://i.ibb.co/Kpp37QqZ/18-Violeta.png"},
            { id:19,nombre:"Rivers (PIO FC)",tipo:"presidenta",imagen:"https://i.ibb.co/hRbZNNry/19-Rivers.png"},
            { id:20,nombre:"Gemita (Porcinas FC)",tipo:"presidenta",imagen:"https://i.ibb.co/kgQqHB40/20-Gemita.png"},
            { id:21,nombre:"Spursito (Rayo de Barcelona)",tipo:"presidenta",imagen:"https://i.ibb.co/CpYRPJ7v/21-Spursito.png"},
            { id:22,nombre:"Totakeki (Saiyans FC)",tipo:"presidenta",imagen:"https://i.ibb.co/fYQ41S7r/22-Totakeki.png"},
            { id:23,nombre:"Noe9977 (Ultimate Móstoles)",tipo:"presidenta",imagen:"https://i.ibb.co/G4qQYCTY/23-Noe9977.png"},
            { id:24,nombre:"Javi Buyer + Eric Minibuyer (Xbuyer Team)",tipo:"presidenta",imagen:"https://i.ibb.co/KjRXYVtY/24-Hnos-Buyer.png"},
            { id:49,nombre:"LaParce",tipo:"presisqlame",imagen:"https://i.ibb.co/HTQjB8jk/49-La-Parce.png"},
            { id:50,nombre:"PipePunk + NataliaMX",tipo:"presisqlame",imagen:"https://i.ibb.co/k2bCqS5h/50-Pipe-Punk-Natalia-MX.png"},
            { id:51,nombre:"IsaRockets + Los Futbolitos",tipo:"presisqlame",imagen:"https://i.ibb.co/387Wd1Z/51-Isa-Rockets-Los-Futbolitos.png"},
            { id:52,nombre:"Castro1021 + Pitaa1021",tipo:"presisqlame",imagen:"https://i.ibb.co/q3ynjfzs/52-Castro1021-Pitaa1021.png"},
            { id:53,nombre:"Deyna Castellanos + Sonia López",tipo:"presisqlame",imagen:"https://i.ibb.co/Cp3jcLjH/53-Deyna-Castellanos-Sonia-L-pez.png"},
            { id:54,nombre:"LlunaClark",tipo:"presisqlame",imagen:"https://i.ibb.co/cScfhD65/54-Lluna-Clark.png"},
            { id:55,nombre:"Jose de Cabo + Jero Freixas",tipo:"presisqlame",imagen:"https://i.ibb.co/CpHkfk6H/55-Jose-De-Cabo-Jero-Freixas.png"},
            { id:56,nombre:"Espe",tipo:"presisqlame",imagen:"https://i.ibb.co/9RvCBDj/56-Espe.png"},
            { id:57,nombre:"Ara + Fer",tipo:"presisqlame",imagen:"https://i.ibb.co/VYwNnf3X/57-Ara-Fer.png"},
            { id:58,nombre:"Crystal Molly + Pame Verdirame",tipo:"presisqlame",imagen:"https://i.ibb.co/Zzs91jx3/58-Crystal-Molly-Pame-Verdirame.png"},
            { id:59,nombre:"Alana + BarcaGamer",tipo:"presisqlame",imagen:"https://i.ibb.co/KcB64KWF/59-Alana-Barca-Gamer.png"},
            { id:60,nombre:"Vicky Palami",tipo:"presisqlame",imagen:"https://i.ibb.co/XfjV2sVQ/60-Vicky-Palami.png"},
            { id:25,nombre:"Ainara Navas",tipo:"supercampeonas",imagen:"https://i.ibb.co/ZRzW9Lx8/25-SUPERCAMPEONAS-Ainara-Navas.png"},
            { id:26,nombre:"Bea Pérez",tipo:"supercampeonas",imagen:"https://i.ibb.co/PswsRSBC/26-SUPERCAMPEONAS-Beatriz-Perez.png"},
            { id:27,nombre:"Alba Ortiz",tipo:"supercampeonas",imagen:"https://i.ibb.co/qMhQgx0f/27-SUPERCAMPEONAS-Alba-Ortiz.png"},
            { id:28,nombre:"Aroney González",tipo:"supercampeonas",imagen:"https://i.ibb.co/0yYfkK9x/28-SUPERCAMPEONAS-Aroney-Gonzalez.png"},
            { id:29,nombre:"Paula Nieto",tipo:"supercampeonas",imagen:"https://i.ibb.co/F4WmsH3C/29-SUPERCAMPEONAS-Paula-Nieto.png"},
            { id:30,nombre:"Blanca Cros",tipo:"supercampeonas",imagen:"https://i.ibb.co/H9Bnsd5/30-SUPERCAMPEONAS-Blanca-Cros.png"},
            { id:31,nombre:"Mar Dalmau",tipo:"supercampeonas",imagen:"https://i.ibb.co/svv4Wrs0/31-SUPERCAMPEONAS-Mar-Dalmau.png"},
            { id:32,nombre:"Zoraida Pichardo",tipo:"supercampeonas",imagen:"https://i.ibb.co/Cs806S8S/32-SUPERCAMPEONAS-Zoraida-Pichardo.png"},
            { id:33,nombre:"Maria Pi",tipo:"supercampeonas",imagen:"https://i.ibb.co/7xWRkBtW/33-SUPERCAMPEONAS-Maria-Pi.png"},
            { id:34,nombre:"Patricia Mascaró",tipo:"supercampeonas",imagen:"https://i.ibb.co/C5g5jLZv/34-SUPERCAMPEONAS-Patricia-Mascar.png"},
            { id:35,nombre:"Berta Velasco",tipo:"supercampeonas",imagen:"https://i.ibb.co/vC7tvZD3/35-SUPERCAMPEONAS-Berta-Velasco.png"},
            { id:36,nombre:"Paula Blas",tipo:"supercampeonas",imagen:"https://i.ibb.co/cKjf90R8/36-SUPERCAMPEONAS-Paula-Blas.png"},
            { id:61,nombre:"Mar Serracanta (1r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/Mx3CK053/61-Mar-Serracanta-Split1-MOMENTS.png"},
            { id:62,nombre:"Alba Mellado (3r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/GQvZ47TP/62-Alba-Mellado-Split3-MOMENTS.png"},
            { id:63,nombre:"Alex Giró (2n Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/j9WX5DsG/63-Alex-Gir-Split2-MOMENTS.png"},
            { id:64,nombre:"Alica Hernández (4o Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/0jpkrTCj/64-Alicia-Hernandez-Split4-MOMENTS.png"},
            { id:69,nombre:"Elena Benítez (3r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/qY3rGshK/69-Elena-Ben-tez-Split3-MOMENTS.png"},
            { id:70,nombre:"Sara Ronzero (Kingdom Cup)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/wh3cnTzS/70-Sara-Ronzero-Kingdom-Cup-MOMENTS.png"},
            { id:65,nombre:"Cinta Vilarroya (4o Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/nJK19Hh/65-Cinta-Vilarroya-Split4-MOMENTS.png"},
            { id:66,nombre:"Mapi Vilas (4o Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/zhXSzJwP/66-Mapi-Vilas-Split4-MOMENTS.png"},
            { id:67,nombre:"Clara Sanz (1r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/NdJmhPXx/67-Clara-Sanz-Split1-MOMENTS.png"},
            { id:68,nombre:"Núria Llop (2o Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/TqDWSymS/68-N-ria-Llop-Split2-MOMENTS.png"},
            { id:71,nombre:"Maria Pi (Kingdom Cup)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/4nF1B0RW/71-Maria-Pi-Kingdom-Cup-MOMENTS.png"},
            { id:72,nombre:"Sara Ismael (3r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/0pxBwRSY/72-Sara-Ismael-Split3-MOMENTS.png"},
            { id:73,nombre:"Alicia Hernandez FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/YnRyfYm/73-Alicia-Hernandez-FLASHBACK.png"},
            { id:74,nombre:"Andrea Chini FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/Z1fFhgNq/74-Andrea-Chini-FLASHBACK.png"},
            { id:75,nombre:"Andrea Martínez FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/rG8nX4WP/75-Andrea-Mart-nez-FLASHBACK.png"},
            { id:76,nombre:"Anna Tan FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/VWjbp9R4/76-Anna-Tan-FLASHBACK.png"},
            { id:77,nombre:"Ari Saez FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/35zgNwHx/77-Ari-Saez-FLASHBACK.png"},
            { id:78,nombre:"Aroney González FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/HLcyWv2N/78-Aroney-Gonz-lez-FLASHBACK.png"},
            { id:79,nombre:"Blanca Cros FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/xSR6yVGt/79-Blanca-Cros-Flashback.png"},
            { id:80,nombre:"Clara Carmona FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/vCqVV2tQ/80-Clara-Carmona-Flashback.png"},
            { id:81,nombre:"Lidia Rabassa (Aniquiladoras FC) FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/gZ8fg6Jv/81-Lidia-Rabassa-Aniquiladoras-Flashback.png"},
            { id:82,nombre:"Lidia Rabassa (Saiyans FC) FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/qYH8ptbr/81-Lidia-Rabassa-Saiyans-Flashback.png"},
            { id:83,nombre:"Mapi Vilas FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/sdM4mMDK/83-Mapi-Vilas-Flashback.png"},
            { id:84,nombre:"Sara Ismael FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/Cpfq9Fts/84-Sara-Isamel-Flashback.png"},
            { id:85,nombre:"Júlia Tomás FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/wNx2CVd4/85-Julia-Tom-s-Flashback.png"},
            { id:86,nombre:"Paula Nieto FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/CpKWG8QJ/86-Paula-Nieto-Flashback.png"},
            { id:87,nombre:"Chapu Avila (1r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/KxLfr0W1/87-Chapu-Avila-Split1-MOMENTS.png"},
            { id:88,nombre:"Jarumi Salazas (2o Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/p6F6j4QR/88-Jarumi-Salazar-Split2-MOMENTS.png"},
            { id:89,nombre:"Jibely Tagle (1r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/VWQmFbXs/89-Jibely-Tangle-Split1-MOMENTS.png"},
            { id:90,nombre:"Nathaly Losada (1r Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/8ghth6vg/90-Nathaly-Losada-Split1-MOMENTS.png"},
            { id:91,nombre:"Paola Castañón (2n Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/0VpBjfgz/91-Paola-Casta-n-Split2-MOMENTS.png"},
            { id:92,nombre:"Vianey Blanquel (2n Split)",tipo:"queensmomentsag25",imagen:"https://i.ibb.co/6c8NYJpS/92-Vianey-Blanquel-Split2-MOMENTS.png"},
            { id:93,nombre:"Dayán Tellez FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/0pthr4Lz/93-Dayan-Tellez-Flashback.png"},
            { id:94,nombre:"Espe FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/DDgJ4sDz/94-Espe-Flashback.png"},
            { id:95,nombre:"Imelda Martínez FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/bjMpGqKY/95-Imelda-Martinez-Flashback.png"},
            { id:96,nombre:"Melanie Hernández FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/LXcBKkhN/96-Melanie-Hernandez-Flashback.png"},
            { id:97,nombre:"Nikol Ramos FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/NgXYV7hL/97-Nikol-Ramos-Flashback.png"},
            { id:98,nombre:"Roxana Torres FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/xthzRjhz/98-Roxana-Torres-Flashback.png"},      
            { id:99,nombre:"Angélica (Angy) Vázquez FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/sdmzNw4v/99-Angelica-Angy-Vazquez-Flashback.png"},
            { id:100,nombre:"Alba Mellado FLASHBACK",tipo:"flashbackag25",imagen:"https://i.ibb.co/nM91H9RC/100-Alba-Mellado-Flashback.png"}
        ];

        const TYPE_WEIGHTS = {
        supercampeonas: 15, 
        presidenta: 30,
        escudo: 40,
        escudoqlame: 40,
        presisqlame: 30,
	    queensmomentsag25: 10,
	    flashbackag25: 10
	    };
        
        const CREATOR_CODES = {
            "izandhh": 10000,
            "marserracanta": 10000,
            "silviakp": 10000,
            "elisaalmendros": 10000,
            "administradorizan": 2000000,
            "administratorizandhh15": 2000000,
        };

        let weightedPool = [];
        let monedas = 0; 
        let coleccion = {}; 
        let packs = [];
        let lastDailyReward = null;
        let redeemedCodes = {};


        // --- FUNCIONES DE PERSISTENCIA Y ESTADO (ACTUALMENTE LOCALSTORAGE) ---
        function loadState() {
            monedas = parseInt(localStorage.getItem('monedas')) || 1500;
            coleccion = JSON.parse(localStorage.getItem('coleccion')) || {};
            packs = JSON.parse(localStorage.getItem('packs')) || [];
            lastDailyReward = localStorage.getItem('lastDailyReward');
            redeemedCodes = JSON.parse(localStorage.getItem('redeemedCodes')) || {};
        }

        function saveState() {
            localStorage.setItem('monedas', monedas);
            localStorage.setItem('coleccion', JSON.stringify(coleccion));
            localStorage.setItem('packs', JSON.stringify(packs));
            localStorage.setItem('lastDailyReward', lastDailyReward);
            localStorage.setItem('redeemedCodes', JSON.stringify(redeemedCodes));
        }

        function updateMonedas(cantidad) {
            monedas += cantidad;
            saveState();
            const panel = userInfoPanel.querySelector('#monedas-panel');
            if (panel) {
                panel.textContent = `Monedas: ${monedas}`;
            }
        }

        function notificacion(mensaje) {
            const noti = document.getElementById('notificacion');
            noti.textContent = mensaje;
            noti.style.display = 'block';
            setTimeout(() => {
                noti.style.display = 'none';
            }, 3000);
        }

        // --- FUNCIONES DE CROMOS Y SOBRES ---
        function buildWeightedPool() {
            weightedPool = [];
            CARDS.forEach(card => {
                const weight = TYPE_WEIGHTS[card.tipo] || 1;
                for (let i = 0; i < weight; i++) {
                    weightedPool.push(card.id);
                }
            });
        }

        function getRandomCard() {
            const index = Math.floor(Math.random() * weightedPool.length);
            const cardId = weightedPool[index];
            return CARDS.find(card => card.id === cardId);
        }

        function addCardToCollection(card) {
            const id = card.id;
            if (coleccion[id]) {
                coleccion[id]++;
            } else {
                coleccion[id] = 1;
            }
            saveState();
        }

        function createPack() {
            const newPack = [];
            for (let i = 0; i < PACK_SLOTS; i++) {
                newPack.push(getRandomCard().id);
            }
            packs.push(newPack);
            saveState();
            renderPacks();
        }

        function abrirSobre(packIndex) {
            if (packIndex >= packs.length) return; 

            const openedCards = packs[packIndex].map(cardId => CARDS.find(c => c.id === cardId));
            
            // 1. Mostrar las cartas en el modal de apertura
            const modalCardsGrid = document.getElementById('modal-cards-grid');
            const modalCardsInfo = document.getElementById('modal-cards-info');
            modalCardsGrid.innerHTML = '';
            
            let html = '';
            openedCards.forEach(card => {
                addCardToCollection(card);
                const isNew = coleccion[card.id] === 1;
                const borderStyle = isNew ? 'border: 3px solid #ffcc00;' : 'border: 3px solid var(--accent);';
                
                html += `
                    <div class="cromo" style="position: relative;">
                        <img src="${card.imagen}" alt="${card.nombre}" style="${borderStyle}">
                        ${isNew ? '<span class="duplicadas" style="background: #ffcc00; color: var(--accent-text); padding: 4px 8px; font-size: 0.8em; top: 0; right: 0;">¡NUEVO!</span>' : ''}
                        <span style="font-size: 0.9em; margin-top: 5px; text-align: center;">${card.nombre}</span>
                    </div>
                `;
            });
            modalCardsGrid.innerHTML = html;
            modalCardsInfo.textContent = '¡Has abierto un sobre!';

            // 2. Eliminar el sobre de la lista y guardar
            packs.splice(packIndex, 1);
            saveState();
            renderPacks(); // Actualiza la lista de sobres

            // 3. Mostrar el modal
            document.getElementById('modal-cards').style.display = 'flex';
        }

        function renderPacks() {
            const packsGrid = document.getElementById('packs-grid');
            if (!packsGrid) return;
            packsGrid.innerHTML = '';

            for (let i = 0; i < TOTAL_PACKS_DISPLAY; i++) {
                const packElement = document.createElement('div');
                packElement.className = 'pack';

                if (i < packs.length) {
                    packElement.innerHTML = `
                        <img src="https://i.ibb.co/3WfK9c1g/sobre-2.png" alt="Sobre de Queens League">
                        <span class="pack-badge">${packs[i].length} Cromos</span>
                    `;
                    // Asignar evento de click para abrir
                    packElement.addEventListener('click', () => abrirSobre(i));
                } else {
                    // Sobres vacíos o indicación de que no hay más
                    packElement.className = 'pack opened';
                    packElement.innerHTML = `
                        <img src="https://i.ibb.co/T1j08mP1/sobre-abierto.png" alt="Sobre abierto">
                        <span class="pack-badge" style="background: var(--cromo-dark-bg); color: var(--white); font-weight: 500;">Vacío</span>
                    `;
                }
                packsGrid.appendChild(packElement);
            }
        }
        
        function renderColeccion(filteredCards = CARDS) {
            const albumDisplay = document.getElementById('album-display');
            if (!albumDisplay) return;
            albumDisplay.innerHTML = '';
            
            const totalCards = CARDS.length;
            const collectedCards = Object.keys(coleccion).filter(id => coleccion[id] > 0).length;
            
            mainContent.innerHTML = `
                <h2>Tu Álbum (${collectedCards}/${totalCards})</h2>
                <div class="menu-principal" style="margin-bottom: 2rem;">
                    <div class="actions">
                        <button id="btn-volver-tienda" class="login-btn" style="background: var(--accent); color: var(--accent-text);">Volver a Tienda</button>
                        <button id="btn-vender-todos" class="login-btn" style="background: ${monedas >= 0 ? '#e11d48' : '#e5e7eb'}; color: var(--white);">Vender Todos los Duplicados</button>
                    </div>
                </div>
                <div id="album-display" class="album-grid"></div>
            `;
            const newAlbumDisplay = document.getElementById('album-display');

            filteredCards.forEach(card => {
                const count = coleccion[card.id] || 0;
                const isCollected = count > 0;

                const cromoElement = document.createElement('div');
                cromoElement.className = 'cromo';
                
                if (isCollected) {
                    const duplicadas = count - 1;
                    
                    cromoElement.innerHTML = `
                        <img src="${card.imagen}" alt="${card.nombre}" style="cursor: pointer;" onclick="showCardDetails(${card.id})">
                        ${duplicadas > 0 ? `<span class="duplicadas">${duplicadas} Duplicadas</span>` : ''}
                        <span style="font-size: 0.9em; margin-top: 5px; text-align: center; color: var(--white); font-weight: 600;">${card.nombre}</span>
                        ${duplicadas > 0 ? `<button class="btn-vender" onclick="venderDuplicada(${card.id}, 1)">Vender (+${SELL_PRICE_PER_DUPE}M)</button>` : ''}
                    `;
                } else {
                    cromoElement.style.opacity = '0.4';
                    cromoElement.innerHTML = `
                        <img src="${REVERSO}" alt="Cromo no obtenido">
                        <span style="font-size: 0.9em; margin-top: 5px; text-align: center; color: var(--white); font-weight: 600;">${card.nombre}</span>
                    `;
                }
                newAlbumDisplay.appendChild(cromoElement);
            });
            
            // Asignar eventos de botones
            document.getElementById('btn-volver-tienda').addEventListener('click', () => {
                renderAlbumContent();
                renderPacks();
            });
            document.getElementById('btn-vender-todos').addEventListener('click', venderTodosDuplicados);
        }

        // --- FUNCIONES DE ACCIONES DEL JUEGO ---
        function venderDuplicada(cardId, cantidad) {
            if (coleccion[cardId] > 1) {
                const dupesToSell = Math.min(cantidad, coleccion[cardId] - 1);
                coleccion[cardId] -= dupesToSell;
                const ganancia = dupesToSell * SELL_PRICE_PER_DUPE;
                updateMonedas(ganancia);
                notificacion(`Vendiste ${dupesToSell} duplicada(s) por ${ganancia} monedas.`);
                renderColeccion();
            } else {
                notificacion("No tienes duplicadas de este cromo para vender.");
            }
        }
        
        function venderTodosDuplicados() {
            let totalGanancia = 0;
            let totalVendidos = 0;

            for (const cardId in coleccion) {
                const count = coleccion[cardId];
                if (count > 1) {
                    const dupesToSell = count - 1;
                    coleccion[cardId] = 1; 
                    totalGanancia += dupesToSell * SELL_PRICE_PER_DUPE;
                    totalVendidos += dupesToSell;
                }
            }

            if (totalVendidos > 0) {
                updateMonedas(totalGanancia);
                notificacion(`Vendiste ${totalVendidos} duplicadas por un total de ${totalGanancia} monedas.`);
                renderColeccion();
            } else {
                notificacion("No tienes duplicados para vender.");
            }
        }
        
        function canjearCodigo() {
            const input = document.getElementById('creator-code-input');
            const code = input.value.toLowerCase().trim();
            const reward = CREATOR_CODES[code];

            if (reward === undefined) {
                notificacion("Código no válido.", true);
            } else if (redeemedCodes[code]) {
                notificacion("Ya has canjeado este código.", true);
            } else {
                updateMonedas(reward);
                redeemedCodes[code] = true;
                localStorage.setItem('redeemedCodes', JSON.stringify(redeemedCodes));
                notificacion(`Código canjeado con éxito. ¡Ganaste ${reward} monedas!`);
                input.value = '';
                document.getElementById('modal-creator-code-close').click();
            }
        }
        
        function dailyReward() {
            const today = new Date().toDateString();
            if (lastDailyReward === today) {
                notificacion("Ya has reclamado tu recompensa diaria hoy.", true);
                return;
            }

            updateMonedas(DAILY_REWARD);
            lastDailyReward = today;
            localStorage.setItem('lastDailyReward', lastDailyReward);
            notificacion(`¡Recompensa diaria de ${DAILY_REWARD} monedas reclamada!`);
        }

        function renderAlbumContent() {
            mainContent.innerHTML = `
                <h2>Tienda de Sobres</h2>
                <div class="menu-principal">
                    <div class="actions">
                        <button id="btn-comprar" class="login-btn" style="background: var(--accent); color: var(--accent-text);">Comprar Sobre (${PACK_COST} Monedas)</button>
                        <button id="btn-ver-album" class="login-btn" style="background: var(--cromo-dark-bg);">Ver Álbum</button>
                        <button id="btn-codigos" class="login-btn" style="background: var(--cromo-dark-bg);">Códigos de Creador</button>
                        <button id="btn-daily" class="login-btn" style="background: var(--cromo-dark-bg);">Reclamo Diario</button>
                    </div>
                </div>
                <h3 style="text-align: center; color: var(--accent); margin-top: 2rem;">Tus Sobres</h3>
                <div id="packs-grid" class="packs-grid">
                    </div>
            `;
            // Asignar eventos
            document.getElementById('btn-comprar').addEventListener('click', () => {
                if (monedas >= PACK_COST) {
                    updateMonedas(-PACK_COST);
                    createPack();
                    notificacion(`Has comprado un sobre por ${PACK_COST} monedas.`);
                } else {
                    notificacion("No tienes suficientes monedas.", true);
                }
            });
            document.getElementById('btn-ver-album').addEventListener('click', () => renderColeccion());
            document.getElementById('btn-codigos').addEventListener('click', () => document.getElementById('modal-creator-code').style.display = 'flex');
            document.getElementById('btn-daily').addEventListener('click', dailyReward);
            
            renderPacks();
        }

        // Esta función se activa al hacer clic en un cromo en el álbum
        window.showCardDetails = function(cardId) {
            const card = CARDS.find(c => c.id === cardId);
            if (!card) return;
            
            document.getElementById('modal-img').src = card.imagen;
            document.getElementById('modal-info-top').textContent = card.nombre;
            document.getElementById('modal').style.display = 'flex';
        };

        // --- CIERRE DE MODALES ---
        document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal').style.display = 'none');
        document.getElementById('modal-cards-close').addEventListener('click', () => document.getElementById('modal-cards').style.display = 'none');
        document.getElementById('modal-creator-code-close').addEventListener('click', () => document.getElementById('modal-creator-code').style.display = 'none');
        document.getElementById('redeem-creator-code').addEventListener('click', canjearCodigo);

        
        // --- FUNCIÓN DE INICIALIZACIÓN AL LOGUEARSE ---
        function inicializarAlbum(userId) {
            // ⚠️ En un proyecto REAL, aquí cargarías los datos de Supabase.
            // Por ahora, cargamos de localStorage (Tu código original)
            loadState(); 
            buildWeightedPool(); // Preparar el pool de cromos
            
            // Renderizar la interfaz
            renderAlbumContent();
            
            // Actualizar el panel de monedas y email en el header
            const userEmail = supabase.auth.session()?.user?.email || 'Usuario';
            userInfoPanel.innerHTML = `<span id="monedas-panel">Monedas: ${monedas}</span> | ${userEmail}`;
        }
        
        // ==========================================================
        // ASIGNAR EVENTOS Y ESTADO INICIAL
        // ==========================================================
        
        document.getElementById('btnLogin').onclick = iniciarSesion;
        document.getElementById('btnRegistro').onclick = registrarUsuario;
        
        supabase.auth.onAuthStateChange(handleAuthChange);

        supabase.auth.getSession().then(({ data: { session } }) => {
            handleAuthChange(null, session);
        });
    </script>

</body>
</html>
